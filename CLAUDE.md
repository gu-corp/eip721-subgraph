# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/claude-code) when working with code in this repository.

## Project Overview

This is an EIP-721 (NFT) subgraph for The Graph Protocol. It indexes Transfer events from ERC-721 contracts and tracks token ownership, contract metadata, and global statistics across multiple Ethereum-compatible networks.

## Common Commands

```bash
# Install dependencies
npm install

# Generate TypeScript types from schema and ABIs
npm run codegen

# Build the subgraph
npm run build

# Clean build artifacts
npm run clean

# Deploy (requires graph auth first)
npm run auth -- --product hosted-service <ACCESS_TOKEN>
npm run deploy -- --product hosted-service <SUBGRAPH_NAME>
```

## Project Structure

```
├── src/mapping.ts          # Main event handler (handleTransfer)
├── schema.graphql          # GraphQL entity definitions
├── subgraph.yaml           # Subgraph manifest configuration
├── networks.json           # Network-specific configurations
├── abis/                   # Contract ABI definitions
│   ├── All.json            # Combined ABI (used in subgraph.yaml)
│   ├── EIP721.json         # Standard ERC-721 ABI
│   └── AddressOwnId.json   # Custom extension ABI
└── generated/              # Auto-generated files (do not edit)
    ├── schema.ts           # Entity classes
    └── EIP721/EIP721.ts    # Contract bindings
```

## Key Concepts

### Entities
- **All**: Singleton entity (`id: "all"`) storing global statistics
- **Token**: Individual NFT with contract reference, tokenID, owner, and mintTime
- **TokenContract**: ERC-721 contract with name, symbol, and metadata support flag
- **Owner**: Address that owns tokens with total count
- **OwnerPerTokenContract**: Tracks how many tokens an owner has per contract

### Transfer Event Flow
1. Validate contract is EIP-721 compliant (via EIP-165 interface checks)
2. Update previous owner's token counts (if not minting)
3. Update new owner's token counts (if not burning)
4. Handle mint/burn by tracking global and contract-level token counts

### Interface IDs
- `01ffc9a7`: EIP-165 (supportsInterface)
- `80ac58cd`: EIP-721 (NFT standard)
- `5b5e139f`: EIP-721 Metadata extension

## Important Notes

- The `generated/` directory is auto-generated by `graph codegen` - never edit manually
- The subgraph starts indexing from block 0 (configurable in networks.json)
- tokenURI fetching was removed to avoid issues with oversized metadata
- The ABI includes multiple Transfer event signatures to handle various ERC-721 implementations
